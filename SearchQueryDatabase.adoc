:toc: macro
:numbered:


= C002 Search and query database server with built-in search

toc::[]

== Introduction

*Description:* This is a functional user story, and it will be solved during Iteration 3,
   starting on Wednesday January 24th

*What is included in this task:* test of ACID transactions, REST API, RDF Triples, Bitemporality, Security.

This task can be parallelized with C001

== Understanding ways to communicate

*Common administrative interfaces include:*

* Admin Interface (port 8001)
* Admin API
* Configuration Manager (port 8002)
* Monitoring Dashboards (port 8002)

*Common development interfaces include:*

* Query Console (port 8000)
* XQuery (native)
* JavaScript (native)
* REST API
* Java API
* Node.js API
* XCC

=== http://docs.marklogic.com/guide/admin/forests[Creating a forest using Admin Interface]

A forest can be created through the Admin interface by using the Create tab in the Forests section.
To create a forest in a cluster host, go to
http://192.168.99.100:8001 for hostname ml1.local,
http://192.168.99.100:18001 for hostname ml2.local
and
http://192.168.99.100:28001 for hostname ml3.local

image::imagenes/C002_images/imagen01.png[imagen01.png]
image::imagenes/C002_images/imagen02.png[imagen02.png]

1 - In the Admin Interface (http://localhost:8001), select Forests on the left.

2 - Select the Create tab in the upper middle.

3 - Enter star-wars-1 in the forest name field, to give the forest a name.

4 -Leave the data directory blank, to have the forest created in the default data directory.

5 -Leave the rest of the options with their defaults.

6 -Click the ok button.

7 -If desired, in a command prompt window, enter ls /var/opt/MarkLogic/Forests to view the new forest:

image:imagenes/C002_images/imagen03.png[imagen03.png]

=== http://docs.marklogic.com/guide/admin/databases[Creating a database using Admin Interface]

A database can be created through the Admin interface by using the Create tab in the databases section.

image:imagenes/C002_images/imagen04.png[imagen04.png]
image:imagenes/C002_images/imagen05.png[imagen05.png]

1- In the Admin Interface of the hostname ml1.local, select Databases on the left.

2- Select the Create tab in the upper middle.

3- For database name, enter star-wars.

4- Click the ok button, to create the database.

5- With the database created, click the Database->Forests link.

6- Select the checkbox to the left of the forest name.

7- Click the ok button.

8- To confirm that the forest is attached to the database, click the database name on the left and then click the Status tab.
    See that the number of forests is 1 and that the star-wars-1 forest is listed:

image:imagenes/C002_images/imagen06.png[imagen06.png]


==== Create a second database

1- In the Admin Interface of the hostname ml2.local, under Configure, select Forests.

2- Select the Create tab.

3- Enter playground-1 in the forest name field, to give the forest a name.

4- Leave the data directory blank, to have the forest created in the default data directory.

5- Leave the rest of the options with their defaults.

6- Click the ok button.

7- On the left, select Databases.

8- Select the Create tab.

9- For database name, enter playground.

10- Click the ok button, to create the database.

11- With the database created, click the Database->Forests link.

12- Select the checkbox to the left of playground-1.

13- Click the ok button.

14- To confirm that the forest is attached to the database, click the database name on the left and then click the Status tab.
    See that the number of forests is 1 and that the playground-1 forest is listed:

image:imagenes/C002_images/imagen07.png[imagen07.png]


=== http://docs.marklogic.com/guide/qconsole[Creating databases and forests using Query Console]

Query Console is a web-based MarkLogic interface, available at port 8000(ml1.local),18000(ml2.local) and 28000(ml3.local) respectively, that allows you to execute JavaScript or XQuery expressions in MarkLogic.

1- Go to http://192.168.99.100:28000
2- See that you are viewing Query Console
image:imagenes/C002_images/imagen08.png[imagen08.png]
3- In the Content Source drop-down list, view the list of databases that already exist (playground was created on ml2.local)
ce
image:imagenes/C002_images/imagen09.png[imagen09.png]
4- In the Query Type drop-down list, notice the query languages:

image:imagenes/C002_images/imagen11.png[imagen08.png]

5- Now, use the admin API to define a forest named top-songs-1, a databases named top-songs, and then attaches the forest to the database.
Write this Javascript code in the query console:

    var admin = require('/MarkLogic/admin.xqy');

    var forestConfig = admin.getConfiguration();
    forestConfig = admin.forestCreate(forestConfig, 'top-songs-1', xdmp.host(), '', '', '');
    admin.saveConfiguration(forestConfig);

    var dbConfig = admin.getConfiguration();
    dbConfig = admin.databaseCreate(dbConfig, 'top-songs', xdmp.database('Security'), xdmp.database('Schemas'));
    admin.saveConfiguration(dbConfig);

    var forestAttachConfig = admin.getConfiguration();
    forestAttachConfig = admin.databaseAttachForest(forestAttachConfig, xdmp.database('top-songs'), xdmp.forest('top-songs-1'));
    admin.saveConfiguration(forestAttachConfig);

6- In Query Console, check that you have JavaScript selected as the Query Type.

image:imagenes/C002_images/imagen10.png[imagen10.png]

7- Realize that, for this code (which is defining a new database), the database selected in the Content Source list is irrelevant.

8- Click the Run button, to execute the code.

9- Realize that the return message of your query response was empty is expected, because you did not retrieve any documents from the selected database.

10- Reload the browser page (F5)

11- Look in the Content Source list to see that the top-songs database now appears in the list:

image:imagenes/C002_images/imagen12.png[imagen12.png]


=== http://docs.marklogic.com/guide/rest-dev[Creating databases and forests using REST API]

The REST Client API provides a set of RESTful services for creating, updating, retrieving, deleting and query documents and metadata.
You can use the REST Client API to work with XML, JSON, text, and binary documents.

REST API client applications interact with MarkLogic Server through a REST API instance, a specially configured HTTP App Server. Each REST API instance is intended to service a single content database and client application.

To sending HTTP request you can use curl or equivalent:

1- To create a new REST instance, send a POST request to the /rest-apis service on port 8002(ml1.local) with a URL of the form "http://host:8002/version/rest-apis":

    http://192.168.99.100:8002/v1/rest-apis

2- The POST body should contain instance configuration information in XML or JSON. Setting the HTTP content-type header to "application/xml" or "application/json" to indicate the content format.
The configuration data must specify at least a name for the instance. Optionally, you can specify additional instance properties such as a group name, database name, modules database name, and port.

Create the instance content (rest_api.json):

    {
      "rest-api": {
        "name": "8060-patents",
        "database": "patents",
        "port": "8060",
        "forests-per-host": 1
      }
    }

3- Create the instance and database "patents" with 1 forest/host by sending a POST request to /rest/apis on port 8002:

    curl --anyauth --user marklogic:marklogic -X POST -d@"rest_api/rest_api.json" -i -H "Content-type: application/json" http://192.168.99.100:8002/v1/rest-apis

4- Execute the curl instance in a command prompt.
5- After a few seconds, see that the response says HTTP/1.1 201 Created:

  HTTP/1.1 401 Unauthorized
  Server: MarkLogic
  WWW-Authenticate: Digest realm="public", qop="auth", nonce="35dcdb3dead88e:o4nMbo5VpcN9XD7Z2n+RNA==", opaque="130674700aba9d6e"
  Content-Type: text/html; charset=utf-8
  Content-Length: 209
  Connection: Keep-Alive
  Keep-Alive: timeout=5

  HTTP/1.1 201 Created
  Server: MarkLogic
  Content-Length: 0
  Connection: Keep-Alive
  Keep-Alive: timeout=5

6- Now, in the Admin Interface, click the Configure link on the left, to be able to see the "patents" databases listed under Databases, the patents-1 forest listed under Forests, and the 8060-patents application server listed under App Servers:

image:imagenes/C002_images/imagen13.png[imagen13.png]

== Inserting Data into a Database

=== Understanding Marklogic storage

==== Storage Data

Data is stored in MarkLogic as a document. This data model is extremely beneficial for loading content as-is, with no schema required.

Document formats supported are JSON, XML, RDF, text, and binary.

Documents in other formats (e.g. PDF, Word, Excel, PowerPoint, and HTML) can be converted to XML or JSON using MarkLogic's conversion functions.

JSON document example:

    {
    "recipe":
      {
        "name": "tofu soup",
        "ingredients": ["tofu block", "carrots", "mushrooms", "green onions", "coconut milk"],
        "directions":
         {
           "preparation": "Chop ingredients into medium-size cubes.",
           "cooking":
           {
             "step1": "In a large pot, combine all ingredients.",
             "step2": "Cook on medium heat for 45 minutes."
           }
         }
      }
    }

==== URI
To be able to address any given document in a MarkLogic database, each document has a unique URI (Uniform Resource Identifier). For example, the following URI might be used for the document illustrated above:

    /recipes/tofu-soup.json

The URI is a string that is defined when a document is being loaded. It is common to put some thought into the URI that you will assign to each of your documents, as any directories in a URI can be used to retrieve documents from the database.

The URI does not refer to the physical location of a document in the database, but rather, provides a unique name for retrieving the document.

If another document is inserted at the same URI, it will replace the previous one.

==== Organizing Documents
Documents can be organized in a database via any directories in the path of a URI and/or via collections.

Specifying directories in the URI of a document provides a way to reference groups of documents in a database based on their URIs.

Example JavaScript reference to documents in a recipes directory:

    xdmp.directory("/recipes/")

Specifying collections for a document provides a way to tag a document with no regard for its URI.

Example collection assignment:

    xdmp.documentAddCollections("/recipes/tofu-soup.json", "vegetarian")

Example JavaScript to reference the documents in a collection named vegetarian:

    fn.collection("vegetarian")

A document can belong to more than one collection.

==== http://docs.marklogic.com/guide/ingestion[Loading Content Into MarkLogic Server]

There are many ways to insert documents into a MarkLogic database. Ways include:

* MarkLogic Content Pump
* REST API
* Java API
* Node.js API
* XCC
* XQuery functions
* JavaScript functions
* WebDAV
* MarkLogic Connector for Hadoop
* Content Processing Framework

=== Inserting Data through Query Console
Query Console can be used to insert documents into a MarkLogic database via JavaScript or XQuery.



==== Inserting via JavaScript



=== Inserting Data through the REST API

=== Using MarkLogic Content Pump to Bulk Load


== Search
== Indexes
=== Indexing
=== Search with indexes
== Semantics

== ACID transactions
== Security
